--------------------------------------------------------------------------------
--------------------------1. Database definition---------------------------------
--------------------------------------------------------------------------------
-- B1:
CREATE DATABASE QUANLYDANCUTEST;
----------------------------

-- B2:
\c QUANLYDANCUTEST

\encoding UTF8

-- B3:
CREATE TABLE NGUOIQUANLY (
    HOTEN VARCHAR(50) NOT NULL,
    TENDANGNHAP VARCHAR(50) NOT NULL UNIQUE,
    MATKHAU VARCHAR(20) NOT NULL,
    SODIENTHOAI CHAR(15) NOT NULL,
    VAITRO BOOLEAN NOT NULL
);

CREATE TABLE NHANKHAU (
    MANHANKHAU SERIAL PRIMARY KEY,
    HOTEN VARCHAR(50) NOT NULL,
    SOCANCUOC VARCHAR(15),
    NGAYSINH DATE NOT NULL,
    GIOITINH BOOLEAN NOT NULL,
    NOISINH VARCHAR(200) NOT NULL,
    NGUYENQUAN VARCHAR(200) NOT NULL,
    DANTOC VARCHAR(20) NOT NULL,
    TONGIAO VARCHAR(20) NOT NULL,
    QUOCTICH VARCHAR(20) NOT NULL,
    NOITHUONGTRU VARCHAR(200),
    NGHENGHIEP VARCHAR(100),
    NGAYTAO DATE,
    GHICHU VARCHAR(200)
);

CREATE TABLE HOKHAU (
    MAHOKHAU SERIAL PRIMARY KEY,
    IDCHUHO INT NOT NULL,
    DIACHI VARCHAR(200) NOT NULL,
    NGAYTAO DATE,
    GHICHU VARCHAR(200),
    TENCHUHO VARCHAR(300),
    FOREIGN KEY (IDCHUHO) REFERENCES NHANKHAU(MANHANKHAU)
);

CREATE TABLE THANHVIENCUAHO (
    MANHANKHAU INT NOT NULL,
    MAHOKHAU INT NOT NULL,
    QUANHEVOICHUHO VARCHAR(100) NOT NULL,
    PRIMARY KEY (MANHANKHAU, MAHOKHAU),
    FOREIGN KEY (MANHANKHAU) REFERENCES NHANKHAU(MANHANKHAU),
    FOREIGN KEY (MAHOKHAU) REFERENCES HOKHAU(MAHOKHAU)
);

CREATE TABLE TAMTRU (
    MAGIAYTAMTRU SERIAL PRIMARY KEY,
    MANHANKHAU INT NOT NULL,
    SODIENTHOAINGUOIDANGKY VARCHAR(15) NOT NULL,
    TUNGAY DATE NOT NULL,
    DENNGAY DATE NOT NULL,
    LYDO VARCHAR(300),
    FOREIGN KEY (MANHANKHAU) REFERENCES NHANKHAU(MANHANKHAU)
);

CREATE TABLE TAMVANG (
    MAGIAYTAMVANG SERIAL PRIMARY KEY,
    MANHANKHAU INT NOT NULL,
    NOITAMTRU VARCHAR(300) NOT NULL,
    TUNGAY DATE NOT NULL,
    DENNGAY DATE NOT NULL,
    LYDO VARCHAR(300),
    FOREIGN KEY (MANHANKHAU) REFERENCES NHANKHAU(MANHANKHAU)
);

CREATE TABLE KHAITU (
    MAGIAYKHAITU SERIAL PRIMARY KEY,
    MANHANKHAUNGUOIKHAI INT NOT NULL,
    MANHANKHAUNGUOICHET INT NOT NULL,
    NGAYKHAI DATE,
    NGAYCHET DATE,
    LYDOCHET VARCHAR(300),
    FOREIGN KEY (MANHANKHAUNGUOIKHAI) REFERENCES NHANKHAU(MANHANKHAU),
    FOREIGN KEY (MANHANKHAUNGUOICHET) REFERENCES NHANKHAU(MANHANKHAU)
);

ALTER TABLE KHAITU
ADD CONSTRAINT UQ_MANHANKHAUNGUOICHET UNIQUE (MANHANKHAUNGUOICHET);

--Database cho đóng phí
CREATE TABLE LOAIPHI (
    MAKHOANTHU SERIAL PRIMARY KEY,
    TEN VARCHAR(50) NOT NULL,
    BATBUOC BOOLEAN NOT NULL,
    SOTIENTRENMOTNGUOI BIGINT NOT NULL,
    NGAYTAO DATE,
    MOTA VARCHAR(300)
);

CREATE TABLE DONGGOP (
    MAHOKHAU INT,
    MAKHOANTHU INT,
    SOTIENCANDONG BIGINT,
    SOTIENDADONG BIGINT,
    TRANGTHAI BOOLEAN NOT NULL,
    NGAYDONG DATE,
    TENCHUHO VARCHAR(300),
    DIACHI VARCHAR(300),
    SOTHANHVIEN INT,
    FOREIGN KEY (MAKHOANTHU) REFERENCES LOAIPHI(MAKHOANTHU)
);

ALTER TABLE DONGGOP
ADD CONSTRAINT fk_donggop_hokhau
FOREIGN KEY (mahokhau) REFERENCES hokhau(mahokhau);
